generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["webirata"]
}

model User {
  id                            String                         @id @default(cuid())
  email                         String                         @unique
  password                      String
  nom                           String?
  prenom                        String?
  role                          Role                           @default(USER)
  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime                       @updatedAt
  passwordResetToken            String?                        @unique
  passwordResetExpires          DateTime?
  contrats                      Contrat[]
  contributions                 Contribution[]
  customerSatisfactionResponses CustomerSatisfactionResponse[]
  demandes                      Demande[]
  devis                         Devis[]
  documents                     Document[]
  assessorInspections           EquipmentInspection[]          @relation("AssessorInspections")
  inspections                   EquipmentInspection[]
  formulairesCrees              FormulairesQuotidiens[]        @relation("AdminFormulaires")
  IrataDisclaimerSubmission     IrataDisclaimerSubmission[]
  invoices                      Invoice[]
  jobPlans                      JobPlan[]
  preJobTrainingSignatures      PreJobTrainingSignature[]
  reponsesFormulaires           ReponseFormulaire[]            @relation("StagiaireReponses")
  traineeProgress               TraineeProgress[]
  traineeSignatures             TraineeSignature?
  trainingSessions              TrainingSession[]              @relation("TrainingSessionTrainees")
  traineeInductionSignatures    TraineeInductionSignature[]

  @@schema("webirata")
}

model Formation {
  id          String   @id @default(cuid())
  titre       String
  description String
  duree       String
  prix        Float
  niveau      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("webirata")
}

model Demande {
  id          String   @id @default(cuid())
  userId      String
  statut      Statut   @default(EN_ATTENTE)
  session     String
  message     String?
  commentaire String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  devis       Devis?

  @@schema("webirata")
}

model Devis {
  id               String     @id @default(cuid())
  demandeId        String     @unique
  userId           String
  numero           String
  client           String
  mail             String
  mail2            String     @default("atikpododzi4@gmail.com")
  adresseLivraison String?
  dateLivraison    DateTime?
  dateExamen       DateTime?
  adresse          String?
  siret            String?
  numNDA           String?
  dateFormation    DateTime?
  suiviPar         String?
  designation      String
  quantite         Int
  unite            String
  prixUnitaire     Float
  tva              Float
  exoneration      String?
  datePriseEffet   DateTime?
  montant          Float
  iban             String?
  bic              String?
  banque           String?
  intituleCompte   String?
  signature        String?
  statut           Statut     @default(EN_ATTENTE)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  contrat          Contrat?
  demande          Demande    @relation(fields: [demandeId], references: [id])
  user             User       @relation(fields: [userId], references: [id])
  documents        Document[]

  @@schema("webirata")
}

model Contrat {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  devisId       String   @unique
  userId        String
  nom           String
  prenom        String
  adresse       String
  profession    String?
  dateSignature DateTime
  signature     String
  statut        String   @default("EN_ATTENTE")
  devis         Devis    @relation(fields: [devisId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  invoices      Invoice[]

  @@index([devisId])
  @@index([userId])
  @@schema("webirata")
}

model Settings {
  id        String   @id @default("1")
  company   Json
  formation Json
  email     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("webirata")
}

model PasswordResetToken {
  email     String   @unique
  token     String
  expires   DateTime
  createdAt DateTime @default(now())

  @@schema("webirata")
}

model Document {
  id              String   @id @default(cuid())
  nom             String
  description     String?
  cloudinaryId    String   @unique
  url             String
  type            String
  public          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String?
  devisId         String?
  certificationId String?
  devis           Devis?   @relation(fields: [devisId], references: [id])
  user            User?    @relation(fields: [userId], references: [id])

  @@schema("webirata")
}

model FormulairesQuotidiens {
  id           String              @id @default(cuid())
  titre        String
  description  String?
  session      String
  dateCreation DateTime            @default(now())
  dateDebut    DateTime
  dateFin      DateTime
  actif        Boolean             @default(true)
  valide       Boolean             @default(false)
  questions    Json
  createdBy    String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  admin        User                @relation("AdminFormulaires", fields: [createdBy], references: [id])
  reponses     ReponseFormulaire[]

  @@schema("webirata")
}

model ReponseFormulaire {
  id               String                @id @default(cuid())
  formulaireId     String
  stagiaireId      String
  dateReponse      DateTime              @default(now())
  reponses         Json
  commentaires     String?
  soumis           Boolean               @default(false)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  commentaireAdmin String?
  decisionAdmin    DecisionAdmin?
  maxScore         Int?
  score            Int?
  scoreAdmin       Int?
  formulaire       FormulairesQuotidiens @relation(fields: [formulaireId], references: [id], onDelete: Cascade)
  stagiaire        User                  @relation("StagiaireReponses", fields: [stagiaireId], references: [id], onDelete: Cascade)

  @@unique([formulaireId, stagiaireId, dateReponse])
  @@schema("webirata")
}

model EquipmentInspection {
  id                           String           @id @default(cuid())
  docNumber                    String           @default("HS019ENG")
  dateOfIssue                  DateTime         @default(now())
  issueNumber                  String           @default("001")
  inspectionDate               DateTime
  technicianName               String
  technicianIrataNo            String
  makeOfItem                   String
  modelOfItem                  String
  itemIdNumber                 String
  standardsConformance         String?
  suitabilityOfItem            String?
  ageOfItem                    String?
  historyOfItem                String?
  metalPartsCondition          String?
  textilePartsCondition        String?
  plasticPartsCondition        String?
  movingPartsFunction          String?
  operationalCheck             String?
  compatibilityCheck           String?
  overallComments              String?
  technicianVerdict            Verdict?
  assessorVerdict              Verdict?
  assessorComments             String?
  candidateCorrectlyIdentified Boolean?
  status                       InspectionStatus @default(DRAFT)
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime         @updatedAt
  technicianId                 String
  assessorId                   String?
  assessor                     User?            @relation("AssessorInspections", fields: [assessorId], references: [id])
  technician                   User             @relation(fields: [technicianId], references: [id])

  @@schema("webirata")
}

model JobPlan {
  id                   String           @id @default(cuid())
  docNumber            String           @default("HS061ENG")
  dateOfIssue          DateTime         @default(now())
  issueNumber          String           @default("001")
  technicianName       String
  technicianIrataNo    String
  jobDate              DateTime
  jobLength            String?
  clientDetails        String?
  taskDetails          String
  location             String
  height               String?
  accessMethod         String?
  communicationMethods String?
  permitRequirements   String?
  anchorStructure      String
  anchorEquipment      String
  accessPlan           String
  evacuationPlan       String
  rescuePlan           String
  status               InspectionStatus @default(DRAFT)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  technicianId         String
  technician           User             @relation(fields: [technicianId], references: [id])

  @@schema("webirata")
}

model TraineeFollowUp {
  id           String             @id @default(cuid())
  title        String             @default("CI.DES TRAINEE FOLLOW UP FORM")
  codeNumber   String             @default("ENR-CIFRA-FORM 004")
  revision     String             @default("01")
  creationDate DateTime           @default(now())
  status       String             @default("ACTIVE")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  levelData    TraineeLevelData[]
  progress     TraineeProgress[]
  signatures   TraineeSignature[]

  @@schema("webirata")
}

model TraineeProgress {
  id           String           @id @default(cuid())
  syllabusItem String
  traineeId    String
  day          String
  completed    Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  followUpId   String?
  followUp     TraineeFollowUp? @relation(fields: [followUpId], references: [id])
  trainee      User             @relation(fields: [traineeId], references: [id], onDelete: Cascade)

  @@unique([syllabusItem, traineeId, day])
  @@schema("webirata")
}

model TraineeLevelData {
  id           String           @id @default(cuid())
  syllabusItem String
  level        String
  required     Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  followUpId   String?
  followUp     TraineeFollowUp? @relation(fields: [followUpId], references: [id])

  @@unique([syllabusItem, level])
  @@schema("webirata")
}

model TraineeSignature {
  id             String           @id @default(cuid())
  traineeId      String           @unique
  signature      String
  adminSignature String?
  isValidated    Boolean          @default(false)
  validatedAt    DateTime?
  currentDay     Int              @default(1)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  followUpId     String?
  sessionId      String?
  followUp       TraineeFollowUp? @relation(fields: [followUpId], references: [id])
  session        TrainingSession? @relation(fields: [sessionId], references: [id])
  trainee        User             @relation(fields: [traineeId], references: [id], onDelete: Cascade)

  @@schema("webirata")
}

model TrainingSession {
  id         String             @id @default(cuid())
  name       String
  startDate  DateTime
  endDate    DateTime
  status     String             @default("ACTIVE")
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  signatures TraineeSignature[]
  trainees   User[]             @relation("TrainingSessionTrainees")

  @@schema("webirata")
}

model Contribution {
  id                String             @id @default(cuid())
  donorName         String
  donorEmail        String
  donorPhone        String?
  amount            Int
  type              ContributionType
  returnAmount      Int
  returnDescription String?
  paymentMethod     PaymentMethod      @default(MOBILE_MONEY)
  status            ContributionStatus @default(PENDING)
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userId            String?
  user              User?              @relation(fields: [userId], references: [id])

  @@schema("webirata")
}

model CustomerSatisfactionResponse {
  id          String                   @id @default(cuid())
  userId      String?
  traineeName String?
  type        CustomerSatisfactionType
  date        DateTime                 @default(now())
  items       Json
  suggestions String?
  session     String?
  signature   String?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  user        User?                    @relation(fields: [userId], references: [id])

  @@schema("webirata")
}

model IrataDisclaimerSubmission {
  id             String                @id
  name           String?
  address        String
  signature      String
  session        String?
  irataNo        String?
  userId         String?
  adminSignature String?
  adminSignedAt  DateTime?
  adminName      String?
  status         IrataDisclaimerStatus @default(PENDING)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime
  User           User?                 @relation(fields: [userId], references: [id])

  @@schema("webirata")
}

enum Role {
  USER
  ADMIN
  GESTIONNAIRE

  @@schema("webirata")
}

enum Statut {
  EN_ATTENTE
  VALIDE
  REFUSE
  ANNULE

  @@schema("webirata")
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  ASSESSED
  APPROVED
  REJECTED

  @@schema("webirata")
}

enum Verdict {
  PASS
  FAIL
  DISCREPANCY

  @@schema("webirata")
}

enum DecisionAdmin {
  ACCEPTE
  REFUSE
  A_REVOIR

  @@schema("webirata")
}

enum ContributionType {
  PREFORMATION
  FINANCIAL
  MATERIAL

  @@schema("webirata")
}

enum ContributionStatus {
  PENDING
  CONFIRMED
  PROCESSED
  CANCELLED

  @@schema("webirata")
}

enum PaymentMethod {
  MOBILE_MONEY
  BANK_TRANSFER
  CASH
  CRYPTO
  VIREMENT

  @@schema("webirata")
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED

  @@schema("webirata")
}

enum CustomerSatisfactionType {
  ENVIRONMENT_RECEPTION
  EQUIPMENT
  TRAINING_PEDAGOGY

  @@schema("webirata")
}

enum IrataDisclaimerStatus {
  PENDING
  SIGNED
  SENT

  @@schema("webirata")
}

model PreJobTrainingSignature {
  id            String   @id @default(cuid())
  day           String   // Jour de la semaine (Lundi, Mardi, etc.)
  signatureData String   // Signature en base64
  userId        String
  userName      String?
  signedAt      DateTime @default(now())
  autoSigned    Boolean  @default(true) // Indique si c'est une signature automatique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("webirata")
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  amount        Float
  paymentStatus PaymentStatus @default(PENDING)
  paidAmount    Float?        // Montant déjà payé pour les paiements partiels
  paymentMethod PaymentMethod?
  notes         String?       // Notes du paiement
  userId        String
  contratId     String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contrat       Contrat       @relation(fields: [contratId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@schema("webirata")
}

model TraineeInduction {
  id             String   @id @default(cuid())
  sessionId      String   // ID de la session de formation
  courseDate     String   // Date du cours
  courseLocation String   // Lieu du cours
  diffusion      String   // Diffusion
  copie          String   // Copie
  adminSignature String   // Signature de l'administrateur
  signatures     TraineeInductionSignature[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@schema("webirata")
}

model TraineeInductionSignature {
  id             String          @id @default(cuid())
  inductionId    String
  userId         String
  userSignature  String          // Signature de l'utilisateur
  induction      TraineeInduction @relation(fields: [inductionId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([inductionId, userId])

  @@schema("webirata")
}
